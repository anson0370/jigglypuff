// Generated by CoffeeScript 1.6.3
(function() {
  var FileNotFoundError, app, dataProvider, env, express, fs, render;

  fs = require("fs");

  env = require("./enviroments");

  render = require("./handlebars/render");

  express = require("express");

  dataProvider = require("./data_provider");

  FileNotFoundError = require("./errors").FileNotFoundError;

  app = express();

  app.get(/^([^\.]+)$/, function(req, res) {
    var dataResult, err, path, result;
    path = req.params[0];
    try {
      result = render.renderFile(path, req.query);
      return res.send(result);
    } catch (_error) {
      err = _error;
      if (err instanceof FileNotFoundError) {
        dataResult = dataProvider.get(path, req.query);
        if (dataResult.found) {
          return res.send(dataResult.result);
        } else {
          console.log("[View Not Found] " + err.path);
          res.status(404);
          return res.send();
        }
      } else {
        throw err;
      }
    }
  });

  app.get(/^(.+)$/, function(req, res) {
    var path, realPath;
    path = req.params[0];
    realPath = "" + env.filesHome + path;
    if (fs.existsSync(realPath)) {
      return res.sendfile(realPath);
    } else {
      console.log("[Resource Not Found] " + realPath);
      res.status(404);
      return res.send();
    }
  });

  app.listen(env.serverPort);

  console.log("server listening at port: " + env.serverPort);

}).call(this);
